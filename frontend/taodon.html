<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>T·∫°o ƒë∆°n</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
</head>
<body>
  <div class="container py-4">
    <h3 class="mb-4">üßæ T·∫°o ƒë∆°n h√†ng</h3>

    <div class="row">
      <div class="col-md-6">
        <h5>Danh s√°ch m√≥n</h5>
        <div id="productGallery" class="d-flex flex-wrap gap-3"></div>
      </div>

      <div class="col-md-6">
        <h5>M√≥n ƒë√£ ch·ªçn</h5>
        <form id="orderForm" class="mb-3">
          <div class="mb-2">
            <label for="customerName" class="form-label">T√™n kh√°ch h√†ng</label>
            <input id="customerName" class="form-control" required />
          </div>

          <div id="selectedItems" class="mb-3"></div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">G·ª≠i ƒë∆°n</button>
            <button type="button" id="resetBtn" class="btn btn-secondary">L√†m m·ªõi</button>
          </div>
        </form>

        <h5>K·∫øt qu·∫£</h5>
        <div id="orderResult"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { getCategories, createOrderJSON } from './api.js';

    window.addEventListener('DOMContentLoaded', () => {
      const gallery = document.getElementById('productGallery');
      const selected = document.getElementById('selectedItems');
      const form = document.getElementById('orderForm');
      const result = document.getElementById('orderResult');
      const resetBtn = document.getElementById('resetBtn');

      const missing = [];
      if (!gallery) missing.push('#productGallery');
      if (!selected) missing.push('#selectedItems');
      if (!form) missing.push('#orderForm');
      if (!result) missing.push('#orderResult');
      if (!resetBtn) missing.push('#resetBtn');
      if (missing.length) {
        console.error('Missing elements in taodon.html:', missing);
        alert('L·ªói: trang thi·∫øu element: ' + missing.join(', '));
        return;
      }

      const selectedMap = new Map();

      async function loadCategories() {
        try {
          const categories = await getCategories();
          (categories || []).forEach(item => {
            const card = document.createElement('div');
            card.className = 'card p-2';
            card.style.width = '160px';
            card.innerHTML = `
              <img src="${item.image}" alt="${item.name}" class="card-img-top" style="height:90px;object-fit:cover;">
              <div class="mt-2"><strong>${item.name}</strong><br>Gi√°: ${parseInt(item.price || 0).toLocaleString()} VNƒê</div>
            `;
            card.addEventListener('click', () => {
              if (selectedMap.has(item.name)) return;
              const row = document.createElement('div');
              row.className = 'order-row d-flex align-items-center gap-2 mb-2';
              row.innerHTML = `
                <strong class="me-2">${item.name}</strong>
                <span>${parseInt(item.price || 0).toLocaleString()} VNƒê</span>
                <input type="number" min="1" value="1" class="form-control d-inline-block w-auto ms-2">
                <button class="btn btn-danger btn-sm ms-2">X√≥a</button>
              `;
              const btn = row.querySelector('button');
              btn.addEventListener('click', () => {
                selectedMap.delete(item.name);
                row.remove();
              });
              selected.appendChild(row);
              selectedMap.set(item.name, { ...item, row });
            });
            gallery.appendChild(card);
          });
        } catch (err) {
          console.error(err);
          alert("Kh√¥ng th·ªÉ t·∫£i m√≥n t·ª´ server.");
        }
      }

      loadCategories();

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nameEl = document.getElementById('customerName');
        const name = nameEl ? nameEl.value.trim() : '';
        if (!name) return alert("Vui l√≤ng nh·∫≠p t√™n kh√°ch h√†ng.");
        if (selectedMap.size === 0) return alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n.");

        const items = [];
        selectedMap.forEach((item, key) => {
          const qtyEl = item.row.querySelector('input');
          const qty = parseInt(qtyEl?.value || 0) || 0;
          if (qty > 0) items.push({ name: key, price: item.price, qty });
        });

        try {
          await createOrderJSON({ customer: name, items });
          const div = document.createElement('div');
          div.className = 'order-item';
          div.innerHTML = `
            <div class="p-3 border rounded mb-3 bg-light">
              <strong>Kh√°ch h√†ng:</strong> ${name}<br>
              <strong>M√≥n h√†ng:</strong>
              <ul>
                ${items.map(i => `<li>${i.name} ‚Äì ${i.qty} x ${parseInt(i.price || 0).toLocaleString()} VNƒê</li>`).join('')}
              </ul>
            </div>
          `;
          result.appendChild(div);
          form.reset();
          selected.innerHTML = '';
          selectedMap.clear();
        } catch (err) {
          console.error(err);
          alert("T·∫°o ƒë∆°n th·∫•t b·∫°i.");
        }
      });

      resetBtn.addEventListener('click', () => {
        form.reset();
        selected.innerHTML = '';
        selectedMap.clear();
        result.innerHTML = '';
      });
    });
  </script>

<!-- Thanh menu d∆∞·ªõi -->
  <nav class="navbar fixed-bottom navbar-light bg-light border-top">
    <div class="container d-flex justify-content-around">
      <a href="home.html" class="text-center text-decoration-none">
        <i class="bi bi-house"></i><br>ƒê∆°n h√†ng
      </a>
      <a href="taodon.html" class="text-center text-decoration-none">
        <i class="bi bi-receipt"></i><br>T·∫°o ƒë∆°n
      </a>
      <a href="danhmuc.html" class="text-center text-decoration-none">
        <i class="bi bi-box-seam"></i><br>Danh m·ª•c
      </a>
      <a href="#" class="text-center text-decoration-none">
        <i class="bi bi-graph-up"></i><br>Th·ªëng k√™
      </a>
      <a href="#" class="text-center text-decoration-none">
        <i class="bi bi-gear"></i><br>C√†i ƒë·∫∑t
      </a>
    </div>
  </nav>

</body>
</html>